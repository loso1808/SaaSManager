var settings = require('./config');

var ora = require('../lib/oracle')(settings);

var express = require('express');
var app = express();

ora.createConnectionPool(settings, function(err, pool) {
  if (err) {
    console.error(err);
    return;
  }
  console.log(pool.getInfo());

  function handleErr(err, res) {
    if (err) {
      if (res) res.status(500).send("" + err);
      console.error(err);
    }
  }

  app.get('/', function(req, res) {
    var query = "SELECT * FROM ( SELECT * FROM PRODUCT ";

    for (var i = 0; i < 5; i++) {
      query = query + " UNION ALL SELECT * FROM PRODUCT "
    }

    query = query + " ) WHERE ROWNUM <= 2500";
    pool.getConnection(function(err, conn) {
      if (err) handleErr(err);
      conn.execute(query, [], function(err, result) {
        if (err) handleErr(err);
        else {
          res.send(JSON.stringify(result));
          conn.close();
        }
      });
    });
  });

  app.listen(3000);

});
